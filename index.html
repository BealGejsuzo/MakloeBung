<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Edit Nama QRIS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>Edit Nama QRIS</h2>

  <!-- Tempat input string QRIS -->
  <textarea id="qrisInput" rows="6" cols="50" placeholder="Tempel string QRIS di sini..."></textarea><br><br>

  <!-- Input nama baru -->
  <input id="newName" placeholder="Nama baru"><br><br>

  <button onclick="generateQR()">Generate QR</button>
  <button onclick="downloadQR()">Download QR</button>

  <div id="qrcode" style="margin-top:20px;"></div>

  <script>
    let qrcode;

    // Fungsi hitung CRC16-CCITT
    function crc16ccitt(str) {
      let crc = 0xFFFF;
      for (let c of str) {
        crc ^= c.charCodeAt(0) << 8;
        for (let i = 0; i < 8; i++) {
          if (crc & 0x8000) {
            crc = (crc << 1) ^ 0x1021;
          } else {
            crc <<= 1;
          }
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, "0");
    }

    // Ganti nama di tag 59 (Merchant Name)
    function replaceName(qris, newName) {
      const regex = /59(\d{2})([0-9A-Z ]+)/;
      const match = qris.match(regex);
      if (!match) return qris;

      const newLen = newName.length.toString().padStart(2, "0");
      let newQris = qris.replace(regex, "59" + newLen + newName);

      // buang CRC lama
      newQris = newQris.replace(/6304.{4}$/, "");

      // hitung ulang CRC
      const crc = crc16ccitt(newQris + "6304");
      return newQris + "6304" + crc;
    }

    function generateQR() {
      const qris = document.getElementById("qrisInput").value.trim();
      const newName = document.getElementById("newName").value.trim();

      if (!qris || !newName) {
        alert("Isi QRIS dan Nama baru dulu!");
        return;
      }

      const newQris = replaceName(qris, newName);

      // clear QR lama
      document.getElementById("qrcode").innerHTML = "";

      qrcode = new QRCode(document.getElementById("qrcode"), {
        text: newQris,
        width: 256,
        height: 256
      });
    }

    function downloadQR() {
      if (!qrcode) {
        alert("Buat QR dulu!");
        return;
      }
      const canvas = document.querySelector("#qrcode canvas");
      if (!canvas) {
        alert("QR belum digenerate!");
        return;
      }
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "qris.png";
      link.click();
    }
  </script>
</body>
</html>
