<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Edit QRIS Merchant Name</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>QRIS Editor</h2>

  <input type="file" accept="image/*" id="fileInput"><br><br>
  <div>
    <label>Nama baru:</label>
    <input id="newName" placeholder="contoh: ZIEE">
  </div><br>
  <button onclick="processQR()">Generate QR Baru</button>
  <button onclick="downloadQR()">Download QR</button>

  <h3>QR Hasil:</h3>
  <div id="qrcode"></div>

  <script>
    let qrisString = "";
    let qrcode;

    // CRC16-CCITT
    function crc16ccitt(str) {
      let crc = 0xFFFF;
      for (let c of str) {
        crc ^= c.charCodeAt(0) << 8;
        for (let i = 0; i < 8; i++) {
          crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) : (crc << 1);
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, "0");
    }

    // replace merchant name (tag 59)
    function replaceName(qris, newName) {
      const regex = /59(\d{2})([0-9A-Z ]+)/;
      const match = qris.match(regex);
      if (!match) return qris;

      const newLen = newName.length.toString().padStart(2, "0");
      let newQris = qris.replace(regex, "59" + newLen + newName);

      // hapus CRC lama
      newQris = newQris.replace(/6304.{4}$/, "");

      // hitung ulang CRC
      const crc = crc16ccitt(newQris + "6304");
      return newQris + "6304" + crc;
    }

    // upload + decode QR
    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function() {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, img.width, img.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) {
            qrisString = code.data.trim();
            alert("QRIS berhasil dibaca:\n" + qrisString);
          } else {
            alert("Gagal membaca QRIS!");
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    function processQR() {
      if (!qrisString) {
        alert("Upload QRIS dulu!");
        return;
      }
      const newName = document.getElementById("newName").value.trim();
      if (!newName) {
        alert("Isi nama baru!");
        return;
      }

      const newQris = replaceName(qrisString, newName);

      document.getElementById("qrcode").innerHTML = "";
      qrcode = new QRCode(document.getElementById("qrcode"), {
        text: newQris,
        width: 256,
        height: 256
      });

      alert("QRIS berhasil dibuat dengan nama baru: " + newName);
    }

    function downloadQR() {
      if (!qrcode) {
        alert("Generate dulu QR baru!");
        return;
      }
      const canvas = document.querySelector("#qrcode canvas");
      if (!canvas) return;
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "qris_new.png";
      link.click();
    }
  </script>
</body>
</html>
